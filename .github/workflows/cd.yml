name: Civic 24 Continuous Integration / Continuous Deployment (CI/CD)

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  FLUTTER_VERSION: "3.38.7"
  EXCLUDED_FILES: ":(exclude)**/*app.router.dart :(exclude)**/*test_helpers.mocks.dart :(exclude)**/*assets.gen.dart"

jobs:
  build-ios:
    name: Build iOS - ${{ matrix.app }} ${{ matrix.flavor }}
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: citizen
            flavor: development
    steps:
      - name: üìö Clone the repository
        uses: actions/checkout@v4

      - name: üöß Setup java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "18.x"

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # # Install Melos and bootstrap the packages. This installs dependencies across the monorepo
      # - name: üì¶ Bootstrap packages with Melos
      #   run: |
      #     dart pub global activate melos
      #     melos clean
      #     melos bootstrap

      # # Format all Dart code using the standard format rules defined
      # - name: üé© Ensure the Dart code is formatted correctly
      #   run: |
      #     melos run flutter:format

      # # Generate localization files
      # - name: üß© Generate localization files
      #   run: |
      #     melos run localization:intl

      # # Run build_runner or any code gen scripts you've defined
      # - name: üß¨ Run code generation
      #   run: |
      #     melos run flutter:build

      # # Run analyzer across all packages to catch lint issues and unused code
      # - name: ‚ú® Analyze the Dart code
      #   run: |
      #     melos run flutter:analyze

      - name: üîê Inject citizen flavor secrets
        if: matrix.app == 'citizen' && matrix.flavor == 'development'
        env:
          DEV_DATA: ${{ secrets.CITIZEN_DEV_SECRETS }}
        run: |
          mkdir -p apps/citizen/secrets
          if [ -z "$DEV_DATA" ]; then echo "CITIZEN_DEV_SECRETS is not set"; exit 1; fi
          # Using a heredoc to safely handle large JSON strings
          cat <<EOF > apps/citizen/secrets/development.json
          $DEV_DATA
          EOF

      - name: üîß Clean and reinstall CocoaPods
        run: |
          # Only run deep clean if necessary; for now, keeping your thorough approach
          pod deintegrate || true
          rm -rf Pods Podfile.lock || true
          pod install --repo-update || true
        working-directory: apps/${{ matrix.app }}/ios

      - name: Build iOS
        run: |
          # 1. Unset all non-essential large environment variables.
          unset CITIZEN_DEV_SECRETS
          unset DEV_DATA
          unset GITHUB_TOKEN
          unset RUNNER_TRACKING_ID
          unset GITHUB_ENV
          unset GITHUB_PATH
          
          # 2. Standard Flutter build
          flutter clean
          flutter pub get
          flutter build ipa --no-codesign --flavor development --dart-define-from-file=secrets/development.json
        working-directory: apps/${{ matrix.app }}

      - name: Package IPA (citizen only)
        if: matrix.app == 'citizen'
        run: |
          set -e
          cd build/ios/iphoneos
          mkdir -p Payload
          # Use copy instead of symlink to avoid potential zip issues in CI
          cp -r Runner.app Payload/
          zip -r app.ipa Payload
        working-directory: apps/${{ matrix.app }}

      - name: Push iOS artifacts to Release
        if: matrix.app == 'citizen'
        uses: ncipollo/release-action@v1
        with:
          artifacts: apps/${{ matrix.app }}/build/ios/iphoneos/app.ipa
          tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
          token: ${{ secrets.TOKEN }}
          allowUpdates: true
          replacesArtifacts: false

  build-android:
    name: Build Android - ${{ matrix.app }} ${{ matrix.flavor }}
    needs: build-ios
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: citizen
            flavor: development

    steps:
      - name: üìö Checkout
        uses: actions/checkout@v4

      - name: üöß Setup java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "18.x"

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # - name: üì¶ Install Melos and bootstrap
      #   run: |
      #     dart pub global activate melos
      #     melos clean
      #     melos bootstrap

      # - name: üé© Format, generate and analyze
      #   run: |
      #     melos run flutter:format || true
      #     melos run localization:intl || true
      #     melos run flutter:build || true
      #     melos run flutter:analyze || true

      - name: üîê Inject citizen flavor secrets (development only)
        if: matrix.app == 'citizen' && matrix.flavor == 'development'
        env:
          DEV: ${{ secrets.CITIZEN_DEV_SECRETS }}
        run: |
          mkdir -p apps/citizen/secrets
          if [ -z "$DEV" ]; then echo "CITIZEN_DEV_SECRETS is not set"; exit 1; fi
          printf '%s' "$DEV" > apps/citizen/secrets/development.json

      - name: üßæ Verify no tracked uncommitted changes in ${{ matrix.app }}
        run: |
          git diff --exit-code -- . $EXCLUDED_FILES
          git status --porcelain --untracked-files=no | tee status.txt
          if [ -s status.txt ]; then echo "Uncommitted tracked changes found" && exit 1; fi
        working-directory: apps/${{ matrix.app }}

      - name: ‚úÖ Validate secrets file (citizen/development only)
        if: matrix.app == 'citizen' && matrix.flavor == 'development'
        run: |
          if [ ! -f secrets/development.json ]; then echo "secrets/development.json not found" && ls -la secrets || (ls -la && exit 1); fi
          python -m json.tool secrets/development.json >/dev/null || (echo "secrets/development.json is not valid JSON" && exit 1)
        working-directory: apps/${{ matrix.app }}

      - name: Build Android
        run: |
          flutter pub get
          if [ "${{ matrix.app }}" = "citizen" ]; then
            flutter build apk --flavor ${{ matrix.flavor }} --target lib/main.dart --dart-define-from-file=secrets/${{ matrix.flavor }}.json --split-per-abi
          else
            flutter build apk --debug --split-per-abi
          fi
        working-directory: apps/${{ matrix.app }}

      - name: Push Android artifacts to Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "apps/${{ matrix.app }}/build/app/outputs/apk/**/*.apk"
          tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
          token: ${{ secrets.TOKEN }}
          allowUpdates: true
          replacesArtifacts: false
