name: Civic 24 Continuous Integration / Continuous Deployment (CI/CD)

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  FLUTTER_VERSION: "3.38.7"
  EXCLUDED_FILES: ":(exclude)**/*app.router.dart :(exclude)**/*test_helpers.mocks.dart :(exclude)**/*assets.gen.dart"

jobs:
  test:
    name: Unit & Widget Tests + Analyze
    runs-on: ubuntu-latest
    steps:
      - name: üìö Checkout
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: üì¶ Install Melos and bootstrap
        run: |
          dart pub global activate melos
          melos clean
          melos bootstrap

      - name: üß™ Run tests across repo
        run: |
          melos exec --dir-exists="test" -- "flutter test --no-pub"

      - name: ‚ú® Analyze
        run: |
          melos run flutter:analyze

  build-ios:
    needs: test
    name: Build iOS - ${{ matrix.app }} ${{ matrix.flavor }}
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: citizen
            flavor: development
          # - app: citizen
          #   flavor: staging
          # - app: citizen
          #   flavor: production
          # - app: admin
          #   flavor: ''
    env:
      CITIZEN_DEV_SECRETS: ${{ secrets.CITIZEN_DEV_SECRETS }}
      CITIZEN_STAGING_SECRETS: ${{ secrets.CITIZEN_STAGING_SECRETS }}
      CITIZEN_PROD_SECRETS: ${{ secrets.CITIZEN_PROD_SECRETS }}
    steps:
      # Clone the repository
      - name: üìö Clone the repository
        uses: actions/checkout@v4 # - This uses the actions/checkout@v4 action to clone the repository's code into the runner's workspace

      # Setup Java
      - name: üöß Setup java
        uses: actions/setup-java@v3 # - This uses the actions/setup-java@v3 action to set up a Java environment with Zulu distribution and Java version 18.x
        with:
          distribution: "zulu"
          java-version: "18.x"

      # Set up Flutter
      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }} # This uses the subosito/flutter-action@v2 action to install Flutter with the stable channel and version 3.32.6

      # Install Melos and bootstrap the packages. This installs dependencies across the monorepo
      - name: üì¶ Bootstrap packages with Melos
        run: |
          dart pub global activate melos
          melos clean
          melos bootstrap

      # Format all Dart code using the standard format rules defined
      - name: üé© Ensure the Dart code is formatted correctly
        run: |
          melos run flutter:format

      # Generate localization files
      - name: üß© Generate localization files
        run: |
          melos run localization:intl

      # Run build_runner or any code gen scripts you've defined
      - name: üß¨ Run code generation
        run: |
          melos run flutter:build

      # Run analyzer across all packages to catch lint issues and unused code
      - name: ‚ú® Analyze the Dart code
        run: |
          melos run flutter:analyze

      - name: üîê Inject citizen flavor secrets (if applicable)
        if: matrix.app == 'citizen'
        env:
          DEV: ${{ env.CITIZEN_DEV_SECRETS }}
          STAGING: ${{ env.CITIZEN_STAGING_SECRETS }}
          PROD: ${{ env.CITIZEN_PROD_SECRETS }}
        run: |
          mkdir -p apps/citizen/secrets
          case "${{ matrix.flavor }}" in
            development)
              if [ -z "$DEV" ]; then echo "CITIZEN_DEV_SECRETS is not set"; exit 1; fi
              cat <<JSON > apps/citizen/secrets/development.json
              $DEV
              JSON
              ;;
            staging)
              if [ -z "$STAGING" ]; then echo "CITIZEN_STAGING_SECRETS is not set"; exit 1; fi
              cat <<JSON > apps/citizen/secrets/staging.json
              $STAGING
              JSON
              ;;
            production)
              if [ -z "$PROD" ]; then echo "CITIZEN_PROD_SECRETS is not set"; exit 1; fi
              cat <<JSON > apps/citizen/secrets/production.json
              $PROD
              JSON
              ;;
            *)
              echo "No secrets to inject for ${{ matrix.app }}"
              ;;
          esac

      - name: üßæ Verify no tracked uncommitted changes in ${{ matrix.app }}
        run: |
          git diff --exit-code -- . $EXCLUDED_FILES
          git status --porcelain --untracked-files=no | tee status.txt
          if [ -s status.txt ]; then echo "Uncommitted tracked changes found" && exit 1; fi
        working-directory: apps/${{ matrix.app }}

      - name: üß† Debug the runner environment
        run: |
          echo "Xcode version:"
          xcodebuild -version
          echo "CocoaPods version:"
          pod --version
          echo "Flutter version:"
          flutter --version

      - name: üîß Clean and reinstall CocoaPods
        run: |
          pod deintegrate || true
          rm -rf Pods Podfile.lock || true
          pod cache clean --all || true
          pod install --repo-update || true
        working-directory: apps/${{ matrix.app }}/ios

      - name: Build iOS
        run: |
          flutter clean
          flutter pub get
          if [ "${{ matrix.app }}" = "citizen" ]; then
            flutter build ipa --flavor ${{ matrix.flavor }} --export-options-plist ios/ExportOptions.plist --dart-define-from-file=apps/citizen/secrets/${{ matrix.flavor }}.json
          else
            flutter build ios --no-codesign
          fi
        working-directory: apps/${{ matrix.app }}

      - name: Package IPA (citizen only)
        if: matrix.app == 'citizen'
        run: |
          set -e
          cd build/ios/iphoneos
          mkdir -p Payload
          cd Payload
          ln -sf ../Runner.app
          cd ..
          zip -r app.ipa Payload
        working-directory: apps/${{ matrix.app }}

      - name: Push iOS artifacts to Release (citizen only)
        if: matrix.app == 'citizen'
        uses: ncipollo/release-action@v1
        with:
          artifacts: apps/${{ matrix.app }}/build/ios/iphoneos/app.ipa
          tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
          token: ${{ secrets.TOKEN }}
          allowUpdates: true
          replacesArtifacts: false

  build-android:
    name: Build Android - ${{ matrix.app }} ${{ matrix.flavor }}
    needs: build-ios
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: citizen
            flavor: development
          # - app: citizen
          #   flavor: staging
          # - app: citizen
          #   flavor: production
          # - app: admin
          #   flavor: ''
    env:
      CITIZEN_DEV_SECRETS: ${{ secrets.CITIZEN_DEV_SECRETS }}
      CITIZEN_STAGING_SECRETS: ${{ secrets.CITIZEN_STAGING_SECRETS }}
      CITIZEN_PROD_SECRETS: ${{ secrets.CITIZEN_PROD_SECRETS }}
    steps:
      - name: üìö Checkout
        uses: actions/checkout@v4

      - name: üöß Setup java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "18.x"

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: üì¶ Install Melos and bootstrap
        run: |
          dart pub global activate melos
          melos clean
          melos bootstrap

      - name: üé© Format, generate and analyze
        run: |
          melos run flutter:format || true
          melos run localization:intl || true
          melos run flutter:build || true
          melos run flutter:analyze || true

      - name: üîê Inject citizen flavor secrets (if applicable)
        if: matrix.app == 'citizen'
        env:
          DEV: ${{ env.CITIZEN_DEV_SECRETS }}
          STAGING: ${{ env.CITIZEN_STAGING_SECRETS }}
          PROD: ${{ env.CITIZEN_PROD_SECRETS }}
        run: |
          mkdir -p apps/citizen/secrets
          case "${{ matrix.flavor }}" in
            development)
              if [ -z "$DEV" ]; then echo "CITIZEN_DEV_SECRETS is not set"; exit 1; fi
              cat <<JSON > apps/citizen/secrets/development.json
              $DEV
              JSON
              ;;
            staging)
              if [ -z "$STAGING" ]; then echo "CITIZEN_STAGING_SECRETS is not set"; exit 1; fi
              cat <<JSON > apps/citizen/secrets/staging.json
              $STAGING
              JSON
              ;;
            production)
              if [ -z "$PROD" ]; then echo "CITIZEN_PROD_SECRETS is not set"; exit 1; fi
              cat <<JSON > apps/citizen/secrets/production.json
              $PROD
              JSON
              ;;
            *)
              echo "No secrets to inject for ${{ matrix.app }}"
              ;;
          esac

      - name: üßæ Verify no tracked uncommitted changes in ${{ matrix.app }}
        run: |
          git diff --exit-code -- . $EXCLUDED_FILES
          git status --porcelain --untracked-files=no | tee status.txt
          if [ -s status.txt ]; then echo "Uncommitted tracked changes found" && exit 1; fi
        working-directory: apps/${{ matrix.app }}

      - name: Build Android
        run: |
          flutter pub get
          if [ "${{ matrix.app }}" = "citizen" ]; then
            flutter build apk --flavor ${{ matrix.flavor }} --target lib/main.dart --dart-define-from-file=apps/citizen/secrets/${{ matrix.flavor }}.json --split-per-abi
          else
            flutter build apk --debug --split-per-abi
          fi
        working-directory: apps/${{ matrix.app }}

      - name: Push Android artifacts to Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "apps/${{ matrix.app }}/build/app/outputs/apk/**/*.apk"
          tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
          token: ${{ secrets.TOKEN }}
          allowUpdates: true
          replacesArtifacts: false
