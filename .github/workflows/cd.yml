name: Civic 24 Continuous Integration / Continuous Deployment (CI/CD)

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  FLUTTER_VERSION: "3.38.7"
  EXCLUDED_FILES: ":(exclude)**/*app.router.dart :(exclude)**/*test_helpers.mocks.dart :(exclude)**/*assets.gen.dart"

jobs:
  build-ios:
    name: Build iOS - ${{ matrix.app }} ${{ matrix.flavor }}
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: citizen
            flavor: development
    env:
      CITIZEN_DEV_SECRETS: ${{ secrets.CITIZEN_DEV_SECRETS }}
    steps:
      # Clone the repository
      - name: ðŸ“š Clone the repository
        uses: actions/checkout@v3 # - Using actions/checkout@v3 for wider compatibility with older/self-hosted runners

      # Setup Java
      - name: ðŸš§ Setup java
        uses: actions/setup-java@v3 # - This uses the actions/setup-java@v3 action to set up a Java environment with Zulu distribution and Java version 18.x
        with:
          distribution: "zulu"
          java-version: "18.x"

      # Set up Flutter
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }} # This uses the subosito/flutter-action@v2 action to install Flutter with the stable channel and version 3.32.6

      # # Install Melos and bootstrap the packages. This installs dependencies across the monorepo
      # - name: ðŸ“¦ Bootstrap packages with Melos
      #   run: |
      #     dart pub global activate melos
      #     melos clean
      #     melos bootstrap

      # # Format all Dart code using the standard format rules defined
      # - name: ðŸŽ© Ensure the Dart code is formatted correctly
      #   run: |
      #     melos run flutter:format

      # # Generate localization files
      # - name: ðŸ§© Generate localization files
      #   run: |
      #     melos run localization:intl

      # # Run build_runner or any code gen scripts you've defined
      # - name: ðŸ§¬ Run code generation
      #   run: |
      #     melos run flutter:build

      # # Run analyzer across all packages to catch lint issues and unused code
      # - name: âœ¨ Analyze the Dart code
      #   run: |
      #     melos run flutter:analyze

      - name: ðŸ” Inject citizen flavor secrets (development only)
        if: matrix.app == 'citizen' && matrix.flavor == 'development'
        env:
          DEV: ${{ secrets.CITIZEN_DEV_SECRETS }}
        run: |
          mkdir -p apps/citizen/secrets
          if [ -z "$DEV" ]; then echo "CITIZEN_DEV_SECRETS is not set"; exit 1; fi
          printf '%s' "$DEV" > apps/citizen/secrets/development.json

      - name: ðŸ§  Debug the runner environment
        run: |
          echo "Xcode version:"
          xcodebuild -version
          echo "CocoaPods version:"
          pod --version
          echo "Flutter version:"
          flutter --version

      - name: âœ… Validate secrets file (citizen/development only)
        if: matrix.app == 'citizen' && matrix.flavor == 'development'
        run: |
          if [ ! -f secrets/development.json ]; then echo "secrets/development.json not found" && ls -la secrets || (ls -la && exit 1); fi
          python -m json.tool secrets/development.json >/dev/null || (echo "secrets/development.json is not valid JSON" && exit 1)
        working-directory: apps/${{ matrix.app }}

      - name: ðŸ”§ Clean and reinstall CocoaPods
        run: |
          pod deintegrate || true
          rm -rf Pods Podfile.lock || true
          pod cache clean --all || true
          pod install --repo-update || true
        working-directory: apps/${{ matrix.app }}/ios

      - name: Build iOS
        run: |
          flutter clean
          flutter pub get
          if [ "${{ matrix.app }}" = "citizen" ]; then
            if [ -f ios/ExportOptions.plist ]; then
              echo "Using ios/ExportOptions.plist for archive export"
              flutter build ipa --flavor ${{ matrix.flavor }} --export-options-plist ios/ExportOptions.plist --dart-define-from-file=secrets/${{ matrix.flavor }}.json
            else
              echo "Warning: ios/ExportOptions.plist not found â€” building ipa without export options"
              flutter build ipa --flavor ${{ matrix.flavor }} --dart-define-from-file=secrets/${{ matrix.flavor }}.json
            fi
          else
            flutter build ios --no-codesign
          fi
        working-directory: apps/${{ matrix.app }}

      - name: Package IPA (citizen only)
        if: matrix.app == 'citizen'
        run: |
          set -e
          cd build/ios/iphoneos
          mkdir -p Payload
          cd Payload
          ln -sf ../Runner.app
          cd ..
          zip -r app.ipa Payload
        working-directory: apps/${{ matrix.app }}

      - name: Push iOS artifacts to Release (citizen only)
        if: matrix.app == 'citizen'
        uses: ncipollo/release-action@v1
        with:
          artifacts: apps/${{ matrix.app }}/build/ios/iphoneos/app.ipa
          tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
          token: ${{ secrets.TOKEN }}
          allowUpdates: true
          replacesArtifacts: false

  build-android:
    name: Build Android - ${{ matrix.app }} ${{ matrix.flavor }}
    needs: build-ios
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: citizen
            flavor: development
    env:
      CITIZEN_DEV_SECRETS: ${{ secrets.CITIZEN_DEV_SECRETS }}
    steps:
      - name: ðŸ“š Checkout
        uses: actions/checkout@v3

      - name: ðŸš§ Setup java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "18.x"

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # - name: ðŸ“¦ Install Melos and bootstrap
      #   run: |
      #     dart pub global activate melos
      #     melos clean
      #     melos bootstrap

      # - name: ðŸŽ© Format, generate and analyze
      #   run: |
      #     melos run flutter:format || true
      #     melos run localization:intl || true
      #     melos run flutter:build || true
      #     melos run flutter:analyze || true

      - name: ðŸ” Inject citizen flavor secrets (development only)
        if: matrix.app == 'citizen' && matrix.flavor == 'development'
        env:
          DEV: ${{ secrets.CITIZEN_DEV_SECRETS }}
        run: |
          mkdir -p apps/citizen/secrets
          if [ -z "$DEV" ]; then echo "CITIZEN_DEV_SECRETS is not set"; exit 1; fi
          printf '%s' "$DEV" > apps/citizen/secrets/development.json

      - name: ðŸ§¾ Verify no tracked uncommitted changes in ${{ matrix.app }}
        run: |
          git diff --exit-code -- . $EXCLUDED_FILES
          git status --porcelain --untracked-files=no | tee status.txt
          if [ -s status.txt ]; then echo "Uncommitted tracked changes found" && exit 1; fi
        working-directory: apps/${{ matrix.app }}

      - name: âœ… Validate secrets file (citizen/development only)
        if: matrix.app == 'citizen' && matrix.flavor == 'development'
        run: |
          if [ ! -f secrets/development.json ]; then echo "secrets/development.json not found" && ls -la secrets || (ls -la && exit 1); fi
          python -m json.tool secrets/development.json >/dev/null || (echo "secrets/development.json is not valid JSON" && exit 1)
        working-directory: apps/${{ matrix.app }}

      - name: Build Android
        run: |
          flutter pub get
          if [ "${{ matrix.app }}" = "citizen" ]; then
            flutter build apk --flavor ${{ matrix.flavor }} --target lib/main.dart --dart-define-from-file=secrets/${{ matrix.flavor }}.json --split-per-abi
          else
            flutter build apk --debug --split-per-abi
          fi
        working-directory: apps/${{ matrix.app }}

      - name: Push Android artifacts to Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "apps/${{ matrix.app }}/build/app/outputs/apk/**/*.apk"
          tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
          token: ${{ secrets.TOKEN }}
          allowUpdates: true
          replacesArtifacts: false
