# name: Civic 24 Continuous Integration / Continuous Deployment (CI/CD)

# on:
#   push:
#     branches:
#       - develop
#   pull_request:
#     branches:
#       - develop

# env:
#   FLUTTER_VERSION: "3.38.7"
#   EXCLUDED_FILES: ":(exclude)**/*app.router.dart :(exclude)**/*test_helpers.mocks.dart :(exclude)**/*assets.gen.dart"
  

# jobs:
#   build-ios:
#     name: Build iOS - ${{ matrix.app }} ${{ matrix.flavor }}
#     runs-on: macos-15
#     strategy:
#       fail-fast: false
#       matrix:
#         include:
#           - app: citizen
#             flavor: development      
#     env:
#       cwd: code/apps/${{ matrix.app }}

#     steps:
#       - name: ðŸ“š Clone the repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 1
#           path: code

#       - name: ðŸš§ Setup java
#         uses: actions/setup-java@v3
#         with:
#           distribution: "zulu"
#           java-version: "18.x"

#       - name: ðŸ¦ Setup Flutter
#         uses: subosito/flutter-action@v2
#         with:
#           channel: "stable"
#           flutter-version: ${{ env.FLUTTER_VERSION }}

#       # # Install Melos and bootstrap the packages. This installs dependencies across the monorepo
#       # - name: ðŸ“¦ Bootstrap packages with Melos
#       #   run: |
#       #     dart pub global activate melos
#       #     melos clean
#       #     melos bootstrap
#       #   working-directory: code

#       # # Format all Dart code using the standard format rules defined
#       # - name: ðŸŽ© Ensure the Dart code is formatted correctly
#       #   run: |
#       #     melos run flutter:format
#       #   working-directory: code

#       # # Generate localization files
#       # - name: ðŸ§© Generate localization files
#       #   run: |
#       #     melos run localization:intl
#       #   working-directory: code

#       # # Run build_runner or any code gen scripts you've defined
#       # - name: ðŸ§¬ Run code generation
#       #   run: |
#       #     melos run flutter:build
#       #   working-directory: code

#       # # Run analyzer across all packages to catch lint issues and unused code
#       # - name: âœ¨ Analyze the Dart code
#       #   run: |
#       #     melos run flutter:analyze
#       #   working-directory: code

#       - name: ðŸ§­ Debug repo layout
#         if: matrix.app == 'citizen' && matrix.flavor == 'development'
#         working-directory: code
#         shell: bash
#         run: |
#           echo "Runner: $(uname -a)"
#           echo "/bin/sh -> $(ls -l /bin/sh || true)"
#           echo "cwd env value: ${{ env.cwd }}"
#           ls -la code || true

#       - name: ðŸ” Decode & write encoded secret (citizen/development)
#         if: matrix.app == 'citizen' && matrix.flavor == 'development'
#         working-directory: ${{ env.cwd }}
#         shell: bash
#         run: |
#           set -euo pipefail
#           mkdir -p secrets
#           SECRET_VALUE="${{ secrets[format('ENCODED_DEVELOPMENT_JSON_{0}', matrix.app)] }}"
#           if [ -z "$SECRET_VALUE" ]; then
#             echo "No Base64 secret found for ${{ matrix.app }}."
#             echo "secrets_file_valid=false" >> $GITHUB_ENV
#             exit 1
#           fi

#           # Portable decode: GNU, BSD, or python fallback
#           printf '%s' "$SECRET_VALUE" | \
#             (base64 --decode 2>/dev/null || base64 -d 2>/dev/null || python -c "import sys,base64; sys.stdout.buffer.write(base64.b64decode(sys.stdin.read()))") \
#             > secrets/development.json || true

#           if [ -s "secrets/development.json" ]; then
#             wc -c "secrets/development.json" | awk '{print "secrets_file_bytes="$1}' >> $GITHUB_ENV
#             shasum -a 256 "secrets/development.json" | awk '{print "secrets_sha256="$1}' >> $GITHUB_ENV
#             echo "secrets_file_valid=true" >> $GITHUB_ENV
#             echo "Secrets file decoded (bytes, sha256) available in env."
#           else
#             echo "Decoded file is empty or decode failed."
#             echo "secrets_file_valid=false" >> $GITHUB_ENV
#             exit 1
#           fi

#       - name: âœ… Validate secrets JSON (citizen/development only)
#         if: matrix.app == 'citizen' && matrix.flavor == 'development'
#         working-directory: ${{ env.cwd }}
#         shell: bash
#         run: |
#           if [ ! -f secrets/development.json ]; then
#             echo "secrets/development.json missing" && ls -la secrets || (ls -la && exit 1)
#           fi
#           python -m json.tool secrets/development.json >/dev/null || (echo "secrets/development.json is not valid JSON" && exit 1)

#       - name: ðŸ”§ Clean and reinstall CocoaPods
#         run: |
#           # Only run deep clean if necessary; for now, keeping your thorough approach
#           pod deintegrate || true
#           rm -rf Pods Podfile.lock || true
#           pod install --repo-update || true
#         working-directory: ${{ env.cwd }}/ios

#       - name: Build iOS
#         run: |
#           # 1. Unset all non-essential large environment variables.
#           unset CITIZEN_DEV_SECRETS
#           unset DEV_DATA
#           unset GITHUB_TOKEN
#           unset RUNNER_TRACKING_ID
#           unset GITHUB_ENV
#           unset GITHUB_PATH
          
#           # 2. Standard Flutter build
#           flutter clean
#           flutter pub get
#           flutter build ipa --no-codesign --flavor development --dart-define-from-file=secrets/development.json
#         working-directory: ${{ env.cwd }}

#       - name: Package IPA (citizen only)
#         if: matrix.app == 'citizen'
#         run: |
#           set -e
#           cd build/ios/iphoneos
#           mkdir -p Payload
#           # Use copy instead of symlink to avoid potential zip issues in CI
#           cp -r Runner.app Payload/
#           zip -r app.ipa Payload
#         working-directory: ${{ env.cwd }}

#       - name: Push iOS artifacts to Release
#         if: matrix.app == 'citizen'
#         uses: ncipollo/release-action@v1
#         with:
#           artifacts: ${{ env.cwd }}/build/ios/iphoneos/app.ipa
#           tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
#           token: ${{ secrets.TOKEN }}
#           allowUpdates: true
#           replacesArtifacts: false

#   build-android:
#     name: Build Android - ${{ matrix.app }} ${{ matrix.flavor }}
#     needs: build-ios
#     runs-on: ubuntu-latest
#     strategy:
#       fail-fast: false
#       matrix:
#         include:
#           - app: citizen
#             flavor: development
#     env:
#       cwd: code/apps/${{ matrix.app }}

#     steps:
#       - name: ðŸ“š Checkout
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 1
#           path: code

#       - name: ðŸš§ Setup java
#         uses: actions/setup-java@v3
#         with:
#           distribution: "zulu"
#           java-version: "18.x"

#       - name: ðŸ¦ Setup Flutter
#         uses: subosito/flutter-action@v2
#         with:
#           channel: "stable"
#           flutter-version: ${{ env.FLUTTER_VERSION }}

#       # - name: ðŸ“¦ Install Melos and bootstrap
#       #   run: |
#       #     dart pub global activate melos
#       #     melos clean
#       #     melos bootstrap
#       #   working-directory: code

#       # - name: ðŸŽ© Format, generate and analyze
#       #   run: |
#       #     melos run flutter:format || true
#       #     melos run localization:intl || true
#       #     melos run flutter:build || true
#       #     melos run flutter:analyze || true
#       #   working-directory: code

#       - name: ðŸ” Decode & write encoded secret (citizen/development)
#         if: matrix.app == 'citizen' && matrix.flavor == 'development'
#         working-directory: ${{ env.cwd }}
#         shell: bash
#         run: |
#           set -euo pipefail
#           mkdir -p secrets
#           SECRET_VALUE="${{ secrets[format('ENCODED_DEVELOPMENT_JSON_{0}', matrix.app)] }}"
#           if [ -z "$SECRET_VALUE" ]; then
#             echo "No Base64 secret found for ${{ matrix.app }}."
#             echo "secrets_file_valid=false" >> $GITHUB_ENV
#             exit 1
#           fi

#           # Portable decode: GNU, BSD, or python fallback
#           printf '%s' "$SECRET_VALUE" | \
#             (base64 --decode 2>/dev/null || base64 -d 2>/dev/null || python -c "import sys,base64;sys.stdout.buffer.write(base64.b64decode(sys.stdin.read()))") \
#             > secrets/development.json || true

#           if [ -s "secrets/development.json" ]; then
#             wc -c "secrets/development.json" | awk '{print "secrets_file_bytes="$1}' >> $GITHUB_ENV
#             shasum -a 256 "secrets/development.json" | awk '{print "secrets_sha256="$1}' >> $GITHUB_ENV
#             echo "secrets_file_valid=true" >> $GITHUB_ENV
#             echo "Secrets file decoded (bytes, sha256) available in env."
#           else
#             echo "Decoded file is empty or decode failed."
#             echo "secrets_file_valid=false" >> $GITHUB_ENV
#             exit 1
#           fi

#       - name: ðŸ§¾ Verify no tracked uncommitted changes in ${{ matrix.app }}
#         run: |
#           git diff --exit-code -- . $EXCLUDED_FILES
#           git status --porcelain --untracked-files=no | tee status.txt
#           if [ -s status.txt ]; then echo "Uncommitted tracked changes found" && exit 1; fi
#         working-directory: ${{ env.cwd }}

#       - name: âœ… Validate secrets file (citizen/development only)
#         if: matrix.app == 'citizen' && matrix.flavor == 'development'
#         working-directory: ${{ env.cwd }}
#         shell: bash
#         run: |
#           if [ ! -f secrets/development.json ]; then echo "secrets/development.json not found" && ls -la secrets || (ls -la && exit 1); fi
#           python -m json.tool secrets/development.json >/dev/null || (echo "secrets/development.json is not valid JSON" && exit 1)

#       - name: Build Android
#         run: |
#           flutter pub get
#           if [ "${{ matrix.app }}" = "citizen" ]; then
#             flutter build apk --flavor ${{ matrix.flavor }} --target lib/main.dart --dart-define-from-file=secrets/${{ matrix.flavor }}.json --split-per-abi
#           else
#             flutter build apk --debug --split-per-abi
#           fi
#         working-directory: ${{ env.cwd }}

#       - name: Push Android artifacts to Release
#         uses: ncipollo/release-action@v1
#         with:
#           artifacts: "${{ env.cwd }}/build/app/outputs/apk/**/*.apk"
#           tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
#           token: ${{ secrets.TOKEN }}
#           allowUpdates: true
#           replacesArtifacts: false


name: Civic 24 Continuous Integration / Continuous Deployment (CI/CD)

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

env:
  FLUTTER_VERSION: "3.38.7"

jobs:
  # build-ios:
  #   name: Build iOS - ${{ matrix.app }} ${{ matrix.flavor }}
  #   runs-on: macos-15

  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - app: citizen
  #           flavor: development

  #   env:
  #     cwd: code/apps/${{ matrix.app }}

  #   steps:
  #     - name: ðŸ“š Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 1
  #         path: code

  #     - name: â˜• Setup Java
  #       uses: actions/setup-java@v3
  #       with:
  #         distribution: zulu
  #         java-version: "18.x"

  #     - name: ðŸ¦ Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         channel: stable
  #         flutter-version: ${{ env.FLUTTER_VERSION }}

  #     # - name: ðŸ“¦ Install Melos & bootstrap
  #     #   run: |
  #     #     dart pub global activate melos
  #     #     melos bootstrap
  #     #   working-directory: code

  #     # - name: ðŸ§¬ Run code generation
  #     #   run: melos run flutter:build
  #     #   working-directory: code

  #     # - name: âœ¨ Analyze code
  #     #   run: melos run flutter:analyze
  #     #   working-directory: code

  #     # ---- Secrets Handling ----
  #     - name: ðŸ” Decode secrets JSON
  #       working-directory: ${{ env.cwd }}
  #       shell: bash
  #       run: |
  #         set -euo pipefail
  #         mkdir -p secrets
  #         SECRET_VALUE="${{ secrets[format('ENCODED_DEVELOPMENT_JSON_{0}', matrix.app)] }}"
  #         if [ -z "$SECRET_VALUE" ]; then
  #           echo "Missing Base64 secret" && exit 1
  #         fi

  #         printf '%s' "$SECRET_VALUE" | \
  #           (base64 --decode 2>/dev/null || base64 -d 2>/dev/null || python -c "import sys,base64;sys.stdout.buffer.write(base64.b64decode(sys.stdin.read()))") \
  #           > secrets/development.json

  #         python -m json.tool secrets/development.json >/dev/null

  #     - name: Prepare Flutter iOS build
  #       working-directory: ${{ env.cwd }}
  #       run: |
  #         flutter clean
  #         flutter pub get

  #     - name: Install CocoaPods
  #       working-directory: ${{ env.cwd }}/ios
  #       run: pod install

  #     # ---- iOS Build ----
  #     - name: Build iOS IPA (unsigned)
  #       working-directory: ${{ env.cwd }}
  #       run: |
  #         flutter clean
  #         flutter pub get
  #         flutter build ipa \
  #           --no-codesign \
  #           --flavor development \
  #           --dart-define-from-file=secrets/development.json

  #     # ---- Upload Artifact ----
  #     - name: ðŸš€ Upload iOS IPA to Release
  #       uses: ncipollo/release-action@v1
  #       with:
  #         artifacts: ${{ env.cwd }}/build/ios/ipa/*.ipa
  #         tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
  #         token: ${{ secrets.TOKEN }}
  #         allowUpdates: true
  #         replacesArtifacts: false

  build-ios:
    name: Build iOS - ${{ matrix.app }} ${{ matrix.flavor }}
    runs-on: macos-15

    strategy:
      fail-fast: false
      matrix:
        include:
          - app: citizen
            flavor: development

    env:
      FLUTTER_VERSION: "3.38.7"
      cwd: code/apps/${{ matrix.app }}

    steps:
      - name: ðŸ“š Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: code

      - name: â˜• Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: "18.x"

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # - name: ðŸ“¦ Install Melos & bootstrap
      #   run: |
      #     dart pub global activate melos
      #     melos bootstrap
      #   working-directory: code

      # - name: ðŸ§¬ Run code generation
      #   run: melos run flutter:build
      #   working-directory: code

      # - name: âœ¨ Analyze code
      #   run: melos run flutter:analyze
      #   working-directory: code

      # ðŸ” Decode Secrets
      - name: ðŸ” Decode secrets JSON
        working-directory: ${{ env.cwd }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p secrets
          SECRET_VALUE="${{ secrets[format('ENCODED_DEVELOPMENT_JSON_{0}', matrix.app)] }}"
          [ -z "$SECRET_VALUE" ] && echo "Missing Base64 secret" && exit 1

          printf '%s' "$SECRET_VALUE" | base64 --decode > secrets/development.json
          python -m json.tool secrets/development.json >/dev/null

      # ðŸ§¹ Clean iOS Pods
      - name: ðŸ§¹ Reset iOS Pods
        working-directory: ${{ env.cwd }}/ios
        run: |
          rm -rf Pods Podfile.lock

      # ðŸ“¦ Install Dart dependencies
      - name: ðŸ“¦ Flutter pub get
        working-directory: ${{ env.cwd }}
        run: flutter pub get

      # ðŸ“± Build IPA
      - name: ðŸ“± Build iOS IPA (unsigned)
        working-directory: ${{ env.cwd }}
        run: |
          flutter build ipa \
            --no-codesign \
            --flavor development \
            --dart-define-from-file=secrets/development.json

      # ðŸš€ Upload Artifact
      - name: ðŸš€ Upload iOS IPA to Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: ${{ env.cwd }}/build/ios/ipa/*.ipa
          tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
          token: ${{ secrets.TOKEN }}
          allowUpdates: true
          replacesArtifacts: false



  # build-android:
  #   name: Build Android - ${{ matrix.app }} ${{ matrix.flavor }}
  #   runs-on: ubuntu-latest

  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - app: citizen
  #           flavor: development

  #   env:
  #     cwd: code/apps/${{ matrix.app }}

  #   steps:
  #     - name: ðŸ“š Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 1
  #         path: code

  #     - name: â˜• Setup Java
  #       uses: actions/setup-java@v3
  #       with:
  #         distribution: zulu
  #         java-version: "18.x"

  #     - name: ðŸ¦ Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         channel: stable
  #         flutter-version: ${{ env.FLUTTER_VERSION }}

  #     - name: ðŸ“¦ Install Melos & bootstrap
  #       run: |
  #         dart pub global activate melos
  #         melos bootstrap
  #       working-directory: code

  #     - name: ðŸ§¬ Run code generation
  #       run: melos run flutter:build
  #       working-directory: code

  #     - name: âœ¨ Analyze code
  #       run: melos run flutter:analyze
  #       working-directory: code

  #     # ---- Secrets Handling ----
  #     - name: ðŸ” Decode secrets JSON
  #       working-directory: ${{ env.cwd }}
  #       shell: bash
  #       run: |
  #         set -euo pipefail
  #         mkdir -p secrets
  #         SECRET_VALUE="${{ secrets[format('ENCODED_DEVELOPMENT_JSON_{0}', matrix.app)] }}"
  #         if [ -z "$SECRET_VALUE" ]; then
  #           echo "Missing Base64 secret" && exit 1
  #         fi

  #         printf '%s' "$SECRET_VALUE" | \
  #           (base64 --decode 2>/dev/null || base64 -d 2>/dev/null || python -c "import sys,base64;sys.stdout.buffer.write(base64.b64decode(sys.stdin.read()))") \
  #           > secrets/development.json

  #         python -m json.tool secrets/development.json >/dev/null

  #     # ---- Android Build ----
  #     - name: Build Android Release APKs
  #       working-directory: ${{ env.cwd }}
  #       run: |
  #         flutter pub get
  #         flutter build apk \
  #           --release \
  #           --flavor development \
  #           --target lib/main.dart \
  #           --dart-define-from-file=secrets/development.json \
  #           --split-per-abi

  #     - name: ðŸš€ Upload Android APKs to Release
  #       uses: ncipollo/release-action@v1
  #       with:
  #         artifacts: "${{ env.cwd }}/build/app/outputs/apk/release/*.apk"
  #         tag: ${{ matrix.app }}-${{ matrix.flavor }}-v1.0.${{ github.run_number }}
  #         token: ${{ secrets.TOKEN }}
  #         allowUpdates: true
  #         replacesArtifacts: false
